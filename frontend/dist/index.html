<!DOCTYPE html>
<html lang="auto">
<head>
  <meta charset="UTF-8">
  
  <!-- SEO Meta Tags -->
  <title>ISP Info - 查询您的IP和互联网服务提供商</title>
  <meta name="description" content="一个可以快速查询您的互联网服务提供商（ISP）、IP地址和地理位置信息的在线工具。">
  <meta name="keywords" content="ISP, IP地址, 地理位置, 网络工具, 互联网服务提供商, IP lookup, what is my IP">
  <link rel="canonical" href="https://ispinfo.io/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ispinfo.io/">
  <meta property="og:title" content="ISP Info - 查询您的IP和互联网服务提供商">
  <meta property="og:description" content="一个可以快速查询您的互联网服务提供商（ISP）、IP地址和地理位置信息的在线工具。">
  <!-- <meta property="og:image" content="URL_TO_YOUR_IMAGE"> -->

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://ispinfo.io/">
  <meta property="twitter:title" content="ISP Info - 查询您的IP和互联网服务提供商">
  <meta property="twitter:description" content="一个可以快速查询您的互联网服务提供商（ISP）、IP地址和地理位置信息的在线工具。">
  <!-- <meta property="twitter:image" content="URL_TO_YOUR_IMAGE"> -->

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script defer="defer" src="/bundle.js"></script>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": "https://ispinfo.io/",
    "name": "ISP Info",
    "description": "一个可以快速查询您的互联网服务提供商（ISP）、IP地址和地理位置信息的在线工具。"
  }
  </script>
</head>
<body>
    <!-- 语言切换器 -->
    <div style="text-align: right; padding: 10px; background-color: #fafafa;">
        <button onclick="setLanguage('en')" style="background: none; border: none; cursor: pointer; font-weight: bold; color: #3498db;" data-i18n-btn="english">English</button>
        <span style="color: #ccc;">|</span>
        <button onclick="setLanguage('zh')" style="background: none; border: none; cursor: pointer;" data-i18n-btn="chinese">中文</button>
    </div>
    
    <div style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
        <div style="width: 100%;">
                <div style="text-align: center;">
                    <h1 data-i18n="title">IP 查询工具</h1>
                    
                    <hr>
                    
                    <p><b data-i18n="currentIp">您的当前IP地址：</b><span id="myIp">正在获取...</span></p>
                    
                    <hr>
                    
                    <h3 data-i18n="queryOther">查询其他IP地址</h3>
                    
                    <table border="1" cellpadding="10" cellspacing="0">
                        <tr>
                            <td>
                                <b data-i18n="enterIp">输入IP地址：</b>
                                <input type="text" id="ip-input" size="20" data-i18n-placeholder="example" placeholder="例如：8.8.8.8">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button onclick="searchIP()" data-i18n-btn="lookup">查询IP信息</button>
                                <button id="search-button" onclick="searchIP()" data-i18n-btn="lookupMyIp">查询本机IP</button>
                            </td>
                        </tr>
                    </table>
                    
                    <div id="loading" style="display:none;">
                        <p><b data-i18n="loading">正在查询中，请稍候...</b></p>
                    </div>
                    
                    <div id="error" style="display:none; color:red;">
                    </div>
                    
                    <div id="result" style="display:none;">
                        <hr>
                        <h3 data-i18n="results">查询结果</h3>
                        
                        <!-- 解析后的数据表格 -->
                        
                        <!-- 基本信息 -->
                        <h4 data-i18n="basicInfo">基本信息</h4>
                        <table border="1" cellpadding="6" cellspacing="0" width="100%">
                            <tr bgcolor="#f0f0f0">
                                <td data-i18n-th="item"><b>项目</b></td>
                                <td data-i18n-th="information"><b>信息</b></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="ipAddress">IP地址</td>
                                <td id="resultIP"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="ipType">IP类型</td>
                                <td id="resultType"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="hostname">主机名</td>
                                <td id="resultHostname"></td>
                            </tr>
                        </table>
                        
                        <br>
                        
                        <!-- 地理位置信息 -->
                        <h4 data-i18n="location">地理位置</h4>
                        <table border="1" cellpadding="6" cellspacing="0" width="100%">
                            <tr bgcolor="#f0f0f0">
                                <td data-i18n-th="item"><b>项目</b></td>
                                <td data-i18n-th="information"><b>信息</b></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="country">国家</td>
                                <td id="resultCountry"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="region">地区/州</td>
                                <td id="resultRegion"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="city">城市</td>
                                <td id="resultCity"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="postal">邮编</td>
                                <td id="resultPostal"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="coordinates">坐标</td>
                                <td id="resultCoordinates"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="timezone">时区</td>
                                <td id="resultTimezone"></td>
                            </tr>
                        </table>
                        
                        <br>
                        
                        <!-- 网络信息 -->
                        <h4 data-i18n="networkInfo">网络信息</h4>
                        <table border="1" cellpadding="6" cellspacing="0" width="100%">
                            <tr bgcolor="#f0f0f0">
                                <td data-i18n-th="item"><b>项目</b></td>
                                <td data-i18n-th="information"><b>信息</b></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="isp">ISP/组织</td>
                                <td id="resultISP"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="asn">ASN</td>
                                <td id="resultASN"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="route">网络段</td>
                                <td id="resultRoute"></td>
                            </tr>
                        </table>
                        
                        <br>
                        
                        <!-- 公司信息 -->
                        <h4 data-i18n="companyInfo">公司信息</h4>
                        <div id="company-info" class="info-section"></div>
                        
                        <br>
                        
                        <!-- 安全信息 -->
                        <h4 data-i18n="securityInfo">安全信息</h4>
                        <div id="security-info" class="info-section security-info"></div>
                        
                        <br>
                        
                        <!-- 货币信息 -->
                        <h4 data-i18n="currencyInfo">货币信息</h4>
                        <div id="currency-info" class="info-section"></div>
                        
                        <br>
                        
                        <!-- JSON 查看器 -->
                        <div class="json-viewer-container" style="text-align: left; margin: 20px 0;">
                            <div class="json-viewer-header">
                                <h4 data-i18n="jsonData">JSON 数据</h4>
                                <div class="json-viewer-actions">
                                    <button onclick="copyToClipboard('json-output')" class="copy-button" data-i18n-title="copy" title="复制">
                                        <i class="fas fa-copy"></i> <span data-i18n="copy">复制</span>
                                    </button>
                                    <button onclick="toggleJsonView()" class="toggle-button" id="toggleJsonView">
                                        <span data-i18n="expandAll">展开全部</span>
                                    </button>
                                </div>
                            </div>
                            <div id="json-output" class="json-viewer"></div>
                        </div>
                    </div>
                    
                    <hr>
                    <p><small data-i18n="instructions">使用说明：输入任意IP地址点击查询，或点击'查询本机IP'查看您的详细信息</small></p>
                    
                </div>
        </div>
    </div>

    <script>
        // 配置
        const config = {
            api: {
                baseUrl: 'https://api.ispinfo.io', // 生产环境API基础URL
                endpoints: {
                    ipInfo: '/api/ipinfo',
                    currentIp: 'https://api.ipify.org?format=json',
                    verifyTurnstile: '/api/verify-turnstile' // Turnstile验证端点
                },
                timeout: 10000, // 10秒超时
                retryCount: 2,  // 失败重试次数
                retryDelay: 1000 // 重试延迟(ms)
            },
            turnstile: {
                siteKey: '0x4AAAAAABjK5dsGrb77UcTY', // 测试用key，生产环境请替换
                theme: 'light', // 主题: 'light' 或 'dark'
                size: 'normal'  // 尺寸: 'normal' 或 'compact'
            },
            useMockData: false, // 切换为true使用模拟数据
            debug: false       // 调试模式
        };

        // 模拟数据 - 用于开发和测试
        const mockData = {
            ip: "1.1.1.1",
            type: "IPv4",
            hostname: "one.one.one.one",
            location: {
                country: {
                    name: "United States",
                    code: "US",
                    flag: { emoji: "🇺🇸" }
                },
                region: { name: "California" },
                city: "Los Angeles",
                postal: "90001",
                coordinates: {
                    latitude: 34.0522,
                    longitude: -118.2437
                }
            },
            time_zone: {
                name: "America/Los_Angeles",
                abbreviation: "PDT",
                offset: "-07:00"
            },
            connection: {
                asn: 13335,
                organization: "Cloudflare, Inc.",
                isp: "Cloudflare",
                route: "1.1.1.0/24"
            },
            company: {
                name: "Cloudflare, Inc.",
                domain: "cloudflare.com"
            },
            security: {
                is_vpn: false,
                is_proxy: true,
                is_tor: false,
                is_cloud: true,
                is_anonymous: true,
                is_threat: false
            },
            last_updated: new Date().toISOString()
        };

        // 加载模拟数据
        function loadMockData() {
            return new Promise((resolve) => {
                // 模拟网络延迟
                setTimeout(() => {
                    showResult(mockData);
                    resolve(mockData);
                }, 500);
            });
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // 应用初始化
        function initializeApp() {
            // 设置事件监听器
            setupEventListeners();
            
            // 获取当前IP并显示
            getCurrentIP();
            
            // 检查URL中是否有IP参数
            const urlParams = new URLSearchParams(window.location.search);
            const ipParam = urlParams.get('ip');
            
            if (ipParam) {
                document.getElementById('ip-input').value = ipParam;
                fetchIPInfo(ipParam);
            }
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 回车键查询
            document.getElementById('ip-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchIP();
                }
            });
            
            // 处理浏览器前进/后退
            window.addEventListener('popstate', handlePopState);
        }
        
        // 处理浏览器历史记录导航
        function handlePopState(event) {
            const urlParams = new URLSearchParams(window.location.search);
            const ip = urlParams.get('ip') || '';
            
            if (ip) {
                document.getElementById('ip-input').value = ip;
                fetchIPInfo(ip);
            } else {
                // 如果没有IP参数，清空输入框并显示当前IP信息
                document.getElementById('ip-input').value = '';
                getCurrentIP();
            }
        }
        
        // 获取当前用户IP
        async function getCurrentIP() {
            try {
                const response = await fetchWithTimeout(config.api.endpoints.currentIp);
                const data = await response.json();
                
                if (data && data.ip) {
                    document.getElementById('myIp').textContent = data.ip;
                    return data.ip;
                }
                throw new Error('Invalid response format');
            } catch (error) {
                console.error('获取IP失败:', error);
                document.getElementById('myIp').textContent = '未知';
                return null;
            }
        }
        
        // 带超时的fetch封装
        function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const { timeout = config.api.timeout } = options;
            
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            return fetch(url, {
                ...options,
                signal: controller.signal
            }).finally(() => clearTimeout(timeoutId));
        }
        
        // 验证Turnstile token
        async function verifyTurnstile(token) {
            if (!token) throw new Error('Turnstile token is required');
            
            try {
                const response = await fetchWithTimeout(
                    new URL(config.api.endpoints.verifyTurnstile, config.api.baseUrl),
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ token })
                    }
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Turnstile验证失败');
                }
                
                const data = await response.json();
                return data.success === true;
                
            } catch (error) {
                console.error('Turnstile验证错误:', error);
                return false;
            }
        }
        
        // 带重试的API请求
        async function fetchWithRetry(url, options = {}, retries = config.api.retryCount, delay = config.api.retryDelay) {
            try {
                const response = await fetchWithTimeout(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries <= 0) throw error;
                
                if (config.debug) {
                    console.log(`请求失败，${delay}ms后重试 (剩余 ${retries} 次)...`);
                }
                
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithRetry(url, options, retries - 1, delay * 1.5);
            }
        }
        
        // 查询IP信息
        async function fetchIPInfo(ip = '') {
            // 显示加载状态
            setLoadingState(true);
            
            // 使用模拟数据
            if (config.useMockData) {
                try {
                    await loadMockData();
                } catch (error) {
                    showError('模拟数据加载失败: ' + error.message);
                } finally {
                    setLoadingState(false);
                }
                return;
            }
            
            try {
                // 验证Turnstile token
                if (!turnstileToken) {
                    throw new Error('请完成人机验证');
                }
                
                // 验证Turnstile token
                const isTurnstileValid = await verifyTurnstile(turnstileToken);
                if (!isTurnstileValid) {
                    throw new Error('人机验证失败，请重试');
                }
                
                // 构建请求URL
                const url = new URL(config.api.endpoints.ipInfo, config.api.baseUrl);
                if (ip) {
                    url.searchParams.append('ip', ip);
                    updateBrowserHistory(ip);
                }
                
                // 发送请求
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Turnstile-Token': turnstileToken
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                // 显示查询结果
                showResult(data);
                
                // 重置Turnstile
                if (turnstile && turnstileWidgetId !== null) {
                    turnstile.reset(turnstileWidgetId);
                    turnstileToken = '';
                    document.getElementById('search-button').disabled = true;
                }
                
            } catch (error) {
                const errorMessage = error.name === 'AbortError' 
                    ? '请求超时，请检查网络连接'
                    : `查询失败: ${error.message}`;
                
                showError(errorMessage);
                console.error('API Error:', error);
                
                // 出错时重置Turnstile
                if (turnstile && turnstileWidgetId !== null) {
                    turnstile.reset(turnstileWidgetId);
                    turnstileToken = '';
                    document.getElementById('search-button').disabled = true;
                }
            } finally {
                setLoadingState(false);
            }
        }
        
        // 更新浏览器历史记录
        function updateBrowserHistory(ip) {
            const url = new URL(window.location);
            url.searchParams.set('ip', ip);
            window.history.pushState({ ip }, '', url);
        }
        
        // 设置加载状态
        function setLoadingState(isLoading) {
            const loadingElement = document.getElementById('loading');
            const resultElement = document.getElementById('result');
            
            if (isLoading) {
                loadingElement.style.display = 'block';
                resultElement.style.display = 'none';
                document.getElementById('error').style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
            }
        }

        // 处理搜索按钮点击
        function searchIP() {
            const ipInput = document.getElementById('ip-input');
            const ip = ipInput.value.trim();
            
            // 如果输入为空，查询当前IP
            if (!ip) {
                getCurrentIP().then(currentIp => {
                    if (currentIp) {
                        fetchIPInfo(currentIp);
                    } else {
                        showError('无法获取当前IP地址');
                    }
                });
                return;
            }
            
            // 验证IP格式
            if (!isValidIP(ip)) {
                showError('请输入有效的IPv4或IPv6地址');
                return;
            }
            
            // 执行查询
            fetchIPInfo(ip);
        }
        
        // 验证IP地址格式
        function isValidIP(ip) {
            // 更严格的IPv4验证
            const ipv4Pattern = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            
            // 更严格的IPv6验证
            const ipv6Pattern = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
            
            return ipv4Pattern.test(ip) || ipv6Pattern.test(ip);
        }
        
        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('result').style.display = 'none';
            
            // 3秒后自动隐藏错误信息
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        // 格式化JSON为HTML
        function formatJsonToHtml(data) {
            const escapeHtml = (str) => {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };

            const formatValue = (value, level = 0) => {
                if (value === null) {
                    return '<span class="null">null</span>';
                }
                
                const type = typeof value;
                
                if (type === 'boolean') {
                    return `<span class="boolean">${value}</span>`;
                }
                
                if (type === 'number') {
                    return `<span class="number">${value}</span>`;
                }
                
                if (type === 'string') {
                    // 检查是否是URL
                    if (value.startsWith('http://') || value.startsWith('https://')) {
                        return `<span class="string">"<a href="${escapeHtml(value)}" target="_blank" rel="noopener noreferrer">${escapeHtml(value)}</a>"</span>`;
                    }
                    // 检查是否是邮箱
                    if (value.includes('@') && value.includes('.')) {
                        return `<span class="string">"<a href="mailto:${escapeHtml(value)}">${escapeHtml(value)}</a>"</span>`;
                    }
                    return `<span class="string">"${escapeHtml(value)}"</span>`;
                }
                
                if (Array.isArray(value)) {
                    if (value.length === 0) return '<span class="bracket">[]</span>';
                    
                    const id = 'arr_' + Math.random().toString(36).substr(2, 9);
                    let html = `<span class="collapsible" onclick="toggleCollapsible(this)" data-id="${id}">[</span>`;
                    html += `<div class="collapsible-content" id="${id}">`;
                    
                    value.forEach((item, index) => {
                        html += '<div style="margin-left: 20px;">';
                        html += formatValue(item, level + 1);
                        if (index < value.length - 1) html += ',';
                        html += '</div>';
                    });
                    
                    html += '</div><span class="bracket">]</span>';
                    return html;
                }
                
                if (type === 'object') {
                    const keys = Object.keys(value);
                    if (keys.length === 0) return '<span class="bracket">{}</span>';
                    
                    const id = 'obj_' + Math.random().toString(36).substr(2, 9);
                    let html = `<span class="collapsible" onclick="toggleCollapsible(this)" data-id="${id}">{</span>`;
                    html += `<div class="collapsible-content" id="${id}">`;
                    
                    keys.forEach((key, index) => {
                        html += '<div style="margin-left: 20px;">';
                        html += `<span class="key">"${key}"</span>: ${formatValue(value[key], level + 1)}`;
                        if (index < keys.length - 1) html += ',';
                        html += '</div>';
                    });
                    
                    html += '</div><span class="bracket">}</span>';
                    return html;
                }
                
                return `<span class="null">${escapeHtml(String(value))}</span>`;
            };
            
            return formatValue(data);
        }
        
        // 切换可折叠内容
        function toggleCollapsible(element) {
            element.classList.toggle('collapsed');
        }
        
        // 切换JSON视图
        function toggleJsonView() {
            const button = document.getElementById('toggleJsonView');
            const t = translations[currentLang];
            const isExpanded = button.textContent.includes(t.collapseAll);
            
            if (isExpanded) {
                button.querySelector('span').textContent = t.expandAll;
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.classList.remove('collapsed');
                });
            } else {
                button.querySelector('span').textContent = t.collapseAll;
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.classList.add('collapsed');
                });
            }
        }
        
        // 复制到剪贴板
        async function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                const originalText = document.querySelector('.copy-button i').parentNode.innerHTML;
                const button = document.querySelector('.copy-button');
                button.innerHTML = '<i class="fas fa-check"></i> 已复制';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('复制失败:', err);
                alert('复制失败，请手动选择并复制');
            }
        }
        
        // 格式化安全信息
        function formatSecurityInfo(security) {
            if (!security) return [];
            
            return [
                { label: 'VPN', value: security.is_vpn ? '是' : '否', isThreat: security.is_vpn },
                { label: '代理', value: security.is_proxy ? '是' : '否', isThreat: security.is_proxy },
                { label: 'Tor', value: security.is_tor ? '是' : '否', isThreat: security.is_tor },
                { label: 'Tor出口节点', value: security.is_tor_exit ? '是' : '否', isThreat: security.is_tor_exit },
                { label: '云服务商', value: security.is_cloud_provider ? '是' : '否', isThreat: false },
                { label: '匿名', value: security.is_anonymous ? '是' : '否', isThreat: security.is_anonymous },
                { label: '威胁', value: security.is_threat ? '是' : '否', isThreat: security.is_threat },
                { label: '滥用IP', value: security.is_abuser ? '是' : '否', isThreat: security.is_abuser },
                { label: '攻击者IP', value: security.is_attacker ? '是' : '否', isThreat: security.is_attacker },
                { label: 'Bogon网络', value: security.is_bogon ? '是' : '否', isThreat: security.is_bogon },
                { label: '中继节点', value: security.is_relay ? '是' : '否', isThreat: security.is_relay }
            ];
        }
        
        // 显示查询结果
        function showResult(data) {
            const t = translations[currentLang];
            
            // 基本信息
            document.getElementById('resultIP').textContent = data.ip || t.unknown;
            document.getElementById('resultType').textContent = data.type || t.unknown;
            document.getElementById('resultHostname').textContent = data.hostname || t.unknown;
            
            // 地理位置
            const countryText = data.location?.country ? 
                `${data.location.country.flag?.emoji || ''} ${data.location.country.name} (${data.location.country.code})` : t.unknown;
            document.getElementById('resultCountry').innerHTML = countryText;
            document.getElementById('resultRegion').textContent = data.location?.region?.name || t.unknown;
            document.getElementById('resultCity').textContent = data.location?.city || t.unknown;
            document.getElementById('resultPostal').textContent = data.location?.postal || t.unknown;
            
            const coordinates = data.location?.latitude ? 
                `${data.location.latitude}, ${data.location.longitude}` : t.unknown;
            document.getElementById('resultCoordinates').textContent = coordinates;
            
            const timezone = data.time_zone ? 
                `${data.time_zone.name} (${data.time_zone.abbreviation})` : t.unknown;
            document.getElementById('resultTimezone').textContent = timezone;
            
            // 网络信息
            document.getElementById('resultISP').textContent = data.connection?.organization || t.unknown;
            document.getElementById('resultASN').textContent = data.connection?.asn ? 
                `AS${data.connection.asn}` : t.unknown;
            document.getElementById('resultRoute').textContent = data.connection?.route || t.unknown;
            
            // 公司信息
            const companyInfo = [];
            if (data.company) {
                if (data.company.name) companyInfo.push(`${t.companyName}: ${data.company.name}`);
                if (data.company.domain) companyInfo.push(`${t.companyDomain}: ${data.company.domain}`);
                if (data.company.type) companyInfo.push(`${t.type}: ${data.company.type}`);
            }
            
            // 安全信息
            const securityInfo = [];
            if (data.security) {
                const securityItems = formatSecurityInfo(data.security);
                securityItems.forEach(item => {
                    const className = item.isThreat ? 'security-threat' : '';
                    securityInfo.push(`<span class="${className}">${item.label}: ${item.value}</span>`);
                });
            }
            
            // 货币信息
            const currencyInfo = [];
            if (data.currency) {
                currencyInfo.push(`${data.currency.name} (${data.currency.code})`);
                currencyInfo.push(`${t.symbol}: ${data.currency.symbol}`);
                if (data.currency.format) {
                    currencyInfo.push(`${t.format}: ${data.currency.format.positive.prefix}1${data.currency.format.positive.suffix}`);
                }
            }
            
            // 更新DOM
            updateSection('company-info', companyInfo.join(' • '));
            updateSection('security-info', securityInfo.join(' • '));
            updateSection('currency-info', currencyInfo.join(' • '));
            
            // 显示结果区域
            document.getElementById('result').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            
            // 格式化并显示JSON数据
            const jsonOutput = document.getElementById('json-output');
            jsonOutput.innerHTML = formatJsonToHtml(data);
            
            // 初始化为收起状态
            setTimeout(() => {
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.classList.add('collapsed');
                });
            }, 100);
        }
        
        // 更新信息块
        function updateSection(sectionId, content) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.innerHTML = content || translations[currentLang].unknown;
                element.style.display = content ? 'block' : 'none';
            }
        }
        
        // 处理浏览器前进/后退按钮
        window.onpopstate = function() {
            const path = window.location.pathname;
            if (path === '/' || path === '') {
                document.title = 'IP Info - My IP';
                document.getElementById('ip-input').value = '';
                // Only fetch visitor's IP if not already loaded
                if (!document.getElementById('ip-address').textContent) {
                    fetchIPInfo();
                }
            } else {
                const ip = path.substring(1);
                document.getElementById('ip-input').value = ip;
                document.title = `IP Info - ${ip}`;
                // Don't fetch IP info here, wait for user to submit the form
            }
        };

        // Turnstile 状态管理
        let turnstileToken = '';
        let turnstileWidgetId = null;
        
        // Turnstile 加载完成回调
        window.onTurnstileLoad = function() {
            renderTurnstile();
            
            // 如果是首页且没有IP参数，自动获取当前IP信息
            const path = window.location.pathname;
            const urlParams = new URLSearchParams(window.location.search);
            
            if ((path === '/' || path === '') && !urlParams.has('ip')) {
                fetchIPInfo();
            }
        };
        
        // 渲染Turnstile验证组件
        function renderTurnstile() {
            // 如果Turnstile未加载或已经渲染过，则跳过
            if (typeof turnstile === 'undefined' || turnstileWidgetId !== null) {
                if (config.debug) {
                    console.log('Turnstile already rendered or not available');
                }
                return;
            }
            
            try {
                turnstileWidgetId = turnstile.render('#cf-turnstile', {
                    sitekey: config.turnstile.siteKey,
                    theme: config.turnstile.theme,
                    size: config.turnstile.size,
                    callback: function(token) {
                        if (config.debug) console.log('Turnstile callback with token:', token.substring(0, 10) + '...');
                        turnstileToken = token;
                        document.getElementById('search-button').disabled = false;
                    },
                    'expired-callback': function() {
                        if (config.debug) console.log('Turnstile token expired');
                        turnstileToken = '';
                        document.getElementById('search-button').disabled = true;
                    },
                    'error-callback': function() {
                        if (config.debug) console.error('Turnstile error');
                        turnstileToken = '';
                        document.getElementById('search-button').disabled = true;
                    }
                });
                
                if (config.debug) {
                    console.log('Turnstile rendered with widget ID:', turnstileWidgetId);
                }
                
            } catch (error) {
                console.error('Error rendering Turnstile:', error);
                // 如果Turnstile渲染失败，仍然允许提交（开发环境）
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.warn('Running in development mode, bypassing Turnstile');
                    document.getElementById('search-button').disabled = false;
                }
            }
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', () => {
            const searchButton = document.getElementById('search-button');
            const ipInput = document.getElementById('ip-input');
            
            // 初始禁用搜索按钮（Turnstile验证通过后启用）
            searchButton.disabled = true;
            
            // 开发环境下自动启用搜索按钮
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                searchButton.disabled = false;
                if (config.debug) console.log('Development mode: search button enabled');
            }
            
            // Try to render Turnstile immediately (in case it's already loaded)
            renderTurnstile();
            
            // If Turnstile is not loaded yet, the onTurnstileLoad callback will handle it
            
            // Handle search form submission
            searchButton.addEventListener('click', searchIP);
            ipInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchIP();
                }
            });
            
            // Update URL and title based on current path
            const path = window.location.pathname;
            if (path !== '/' && path !== '') {
                const ip = path.substring(1);
                ipInput.value = ip;
                document.title = `IP Info - ${ip}`;
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="auto">
<head>
  <meta charset="UTF-8">
  
  <!-- SEO Meta Tags -->
  <title>ISP Info - æŸ¥è¯¢æ‚¨çš„IPå’Œäº’è”ç½‘æœåŠ¡æä¾›å•†</title>
  <meta name="description" content="ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ‚¨çš„äº’è”ç½‘æœåŠ¡æä¾›å•†ï¼ˆISPï¼‰ã€IPåœ°å€å’Œåœ°ç†ä½ç½®ä¿¡æ¯çš„åœ¨çº¿å·¥å…·ã€‚">
  <meta name="keywords" content="ISP, IPåœ°å€, åœ°ç†ä½ç½®, ç½‘ç»œå·¥å…·, äº’è”ç½‘æœåŠ¡æä¾›å•†, IP lookup, what is my IP">
  <link rel="canonical" href="https://ispinfo.io/">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://ispinfo.io/">
  <meta property="og:title" content="ISP Info - æŸ¥è¯¢æ‚¨çš„IPå’Œäº’è”ç½‘æœåŠ¡æä¾›å•†">
  <meta property="og:description" content="ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ‚¨çš„äº’è”ç½‘æœåŠ¡æä¾›å•†ï¼ˆISPï¼‰ã€IPåœ°å€å’Œåœ°ç†ä½ç½®ä¿¡æ¯çš„åœ¨çº¿å·¥å…·ã€‚">
  <!-- <meta property="og:image" content="URL_TO_YOUR_IMAGE"> -->

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://ispinfo.io/">
  <meta property="twitter:title" content="ISP Info - æŸ¥è¯¢æ‚¨çš„IPå’Œäº’è”ç½‘æœåŠ¡æä¾›å•†">
  <meta property="twitter:description" content="ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ‚¨çš„äº’è”ç½‘æœåŠ¡æä¾›å•†ï¼ˆISPï¼‰ã€IPåœ°å€å’Œåœ°ç†ä½ç½®ä¿¡æ¯çš„åœ¨çº¿å·¥å…·ã€‚">
  <!-- <meta property="twitter:image" content="URL_TO_YOUR_IMAGE"> -->

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script defer="defer" src="/bundle.js"></script>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "url": "https://ispinfo.io/",
    "name": "ISP Info",
    "description": "ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ‚¨çš„äº’è”ç½‘æœåŠ¡æä¾›å•†ï¼ˆISPï¼‰ã€IPåœ°å€å’Œåœ°ç†ä½ç½®ä¿¡æ¯çš„åœ¨çº¿å·¥å…·ã€‚"
  }
  </script>
</head>
<body>
    <!-- è¯­è¨€åˆ‡æ¢å™¨ -->
    <div style="text-align: right; padding: 10px; background-color: #fafafa;">
        <button onclick="setLanguage('en')" style="background: none; border: none; cursor: pointer; font-weight: bold; color: #3498db;" data-i18n-btn="english">English</button>
        <span style="color: #ccc;">|</span>
        <button onclick="setLanguage('zh')" style="background: none; border: none; cursor: pointer;" data-i18n-btn="chinese">ä¸­æ–‡</button>
    </div>
    
    <div style="max-width: 900px; margin: 0 auto; padding: 0 20px;">
        <div style="width: 100%;">
                <div style="text-align: center;">
                    <h1 data-i18n="title">IP æŸ¥è¯¢å·¥å…·</h1>
                    
                    <hr>
                    
                    <p><b data-i18n="currentIp">æ‚¨çš„å½“å‰IPåœ°å€ï¼š</b><span id="myIp">æ­£åœ¨è·å–...</span></p>
                    
                    <hr>
                    
                    <h3 data-i18n="queryOther">æŸ¥è¯¢å…¶ä»–IPåœ°å€</h3>
                    
                    <table border="1" cellpadding="10" cellspacing="0">
                        <tr>
                            <td>
                                <b data-i18n="enterIp">è¾“å…¥IPåœ°å€ï¼š</b>
                                <input type="text" id="ip-input" size="20" data-i18n-placeholder="example" placeholder="ä¾‹å¦‚ï¼š8.8.8.8">
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button onclick="searchIP()" data-i18n-btn="lookup">æŸ¥è¯¢IPä¿¡æ¯</button>
                                <button id="search-button" onclick="searchIP()" data-i18n-btn="lookupMyIp">æŸ¥è¯¢æœ¬æœºIP</button>
                            </td>
                        </tr>
                    </table>
                    
                    <div id="loading" style="display:none;">
                        <p><b data-i18n="loading">æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œè¯·ç¨å€™...</b></p>
                    </div>
                    
                    <div id="error" style="display:none; color:red;">
                    </div>
                    
                    <div id="result" style="display:none;">
                        <hr>
                        <h3 data-i18n="results">æŸ¥è¯¢ç»“æœ</h3>
                        
                        <!-- è§£æåçš„æ•°æ®è¡¨æ ¼ -->
                        
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <h4 data-i18n="basicInfo">åŸºæœ¬ä¿¡æ¯</h4>
                        <table border="1" cellpadding="6" cellspacing="0" width="100%">
                            <tr bgcolor="#f0f0f0">
                                <td data-i18n-th="item"><b>é¡¹ç›®</b></td>
                                <td data-i18n-th="information"><b>ä¿¡æ¯</b></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="ipAddress">IPåœ°å€</td>
                                <td id="resultIP"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="ipType">IPç±»å‹</td>
                                <td id="resultType"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="hostname">ä¸»æœºå</td>
                                <td id="resultHostname"></td>
                            </tr>
                        </table>
                        
                        <br>
                        
                        <!-- åœ°ç†ä½ç½®ä¿¡æ¯ -->
                        <h4 data-i18n="location">åœ°ç†ä½ç½®</h4>
                        <table border="1" cellpadding="6" cellspacing="0" width="100%">
                            <tr bgcolor="#f0f0f0">
                                <td data-i18n-th="item"><b>é¡¹ç›®</b></td>
                                <td data-i18n-th="information"><b>ä¿¡æ¯</b></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="country">å›½å®¶</td>
                                <td id="resultCountry"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="region">åœ°åŒº/å·</td>
                                <td id="resultRegion"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="city">åŸå¸‚</td>
                                <td id="resultCity"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="postal">é‚®ç¼–</td>
                                <td id="resultPostal"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="coordinates">åæ ‡</td>
                                <td id="resultCoordinates"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="timezone">æ—¶åŒº</td>
                                <td id="resultTimezone"></td>
                            </tr>
                        </table>
                        
                        <br>
                        
                        <!-- ç½‘ç»œä¿¡æ¯ -->
                        <h4 data-i18n="networkInfo">ç½‘ç»œä¿¡æ¯</h4>
                        <table border="1" cellpadding="6" cellspacing="0" width="100%">
                            <tr bgcolor="#f0f0f0">
                                <td data-i18n-th="item"><b>é¡¹ç›®</b></td>
                                <td data-i18n-th="information"><b>ä¿¡æ¯</b></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="isp">ISP/ç»„ç»‡</td>
                                <td id="resultISP"></td>
                            </tr>
                            <tr bgcolor="#f9f9f9">
                                <td data-i18n-td="asn">ASN</td>
                                <td id="resultASN"></td>
                            </tr>
                            <tr>
                                <td data-i18n-td="route">ç½‘ç»œæ®µ</td>
                                <td id="resultRoute"></td>
                            </tr>
                        </table>
                        
                        <br>
                        
                        <!-- å…¬å¸ä¿¡æ¯ -->
                        <h4 data-i18n="companyInfo">å…¬å¸ä¿¡æ¯</h4>
                        <div id="company-info" class="info-section"></div>
                        
                        <br>
                        
                        <!-- å®‰å…¨ä¿¡æ¯ -->
                        <h4 data-i18n="securityInfo">å®‰å…¨ä¿¡æ¯</h4>
                        <div id="security-info" class="info-section security-info"></div>
                        
                        <br>
                        
                        <!-- è´§å¸ä¿¡æ¯ -->
                        <h4 data-i18n="currencyInfo">è´§å¸ä¿¡æ¯</h4>
                        <div id="currency-info" class="info-section"></div>
                        
                        <br>
                        
                        <!-- JSON æŸ¥çœ‹å™¨ -->
                        <div class="json-viewer-container" style="text-align: left; margin: 20px 0;">
                            <div class="json-viewer-header">
                                <h4 data-i18n="jsonData">JSON æ•°æ®</h4>
                                <div class="json-viewer-actions">
                                    <button onclick="copyToClipboard('json-output')" class="copy-button" data-i18n-title="copy" title="å¤åˆ¶">
                                        <i class="fas fa-copy"></i> <span data-i18n="copy">å¤åˆ¶</span>
                                    </button>
                                    <button onclick="toggleJsonView()" class="toggle-button" id="toggleJsonView">
                                        <span data-i18n="expandAll">å±•å¼€å…¨éƒ¨</span>
                                    </button>
                                </div>
                            </div>
                            <div id="json-output" class="json-viewer"></div>
                        </div>
                    </div>
                    
                    <hr>
                    <p><small data-i18n="instructions">ä½¿ç”¨è¯´æ˜ï¼šè¾“å…¥ä»»æ„IPåœ°å€ç‚¹å‡»æŸ¥è¯¢ï¼Œæˆ–ç‚¹å‡»'æŸ¥è¯¢æœ¬æœºIP'æŸ¥çœ‹æ‚¨çš„è¯¦ç»†ä¿¡æ¯</small></p>
                    
                </div>
        </div>
    </div>

    <script>
        // é…ç½®
        const config = {
            api: {
                baseUrl: 'https://api.ispinfo.io', // ç”Ÿäº§ç¯å¢ƒAPIåŸºç¡€URL
                endpoints: {
                    ipInfo: '/api/ipinfo',
                    currentIp: 'https://api.ipify.org?format=json',
                    verifyTurnstile: '/api/verify-turnstile' // TurnstileéªŒè¯ç«¯ç‚¹
                },
                timeout: 10000, // 10ç§’è¶…æ—¶
                retryCount: 2,  // å¤±è´¥é‡è¯•æ¬¡æ•°
                retryDelay: 1000 // é‡è¯•å»¶è¿Ÿ(ms)
            },
            turnstile: {
                siteKey: '0x4AAAAAABjK5dsGrb77UcTY', // æµ‹è¯•ç”¨keyï¼Œç”Ÿäº§ç¯å¢ƒè¯·æ›¿æ¢
                theme: 'light', // ä¸»é¢˜: 'light' æˆ– 'dark'
                size: 'normal'  // å°ºå¯¸: 'normal' æˆ– 'compact'
            },
            useMockData: false, // åˆ‡æ¢ä¸ºtrueä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            debug: false       // è°ƒè¯•æ¨¡å¼
        };

        // æ¨¡æ‹Ÿæ•°æ® - ç”¨äºå¼€å‘å’Œæµ‹è¯•
        const mockData = {
            ip: "1.1.1.1",
            type: "IPv4",
            hostname: "one.one.one.one",
            location: {
                country: {
                    name: "United States",
                    code: "US",
                    flag: { emoji: "ğŸ‡ºğŸ‡¸" }
                },
                region: { name: "California" },
                city: "Los Angeles",
                postal: "90001",
                coordinates: {
                    latitude: 34.0522,
                    longitude: -118.2437
                }
            },
            time_zone: {
                name: "America/Los_Angeles",
                abbreviation: "PDT",
                offset: "-07:00"
            },
            connection: {
                asn: 13335,
                organization: "Cloudflare, Inc.",
                isp: "Cloudflare",
                route: "1.1.1.0/24"
            },
            company: {
                name: "Cloudflare, Inc.",
                domain: "cloudflare.com"
            },
            security: {
                is_vpn: false,
                is_proxy: true,
                is_tor: false,
                is_cloud: true,
                is_anonymous: true,
                is_threat: false
            },
            last_updated: new Date().toISOString()
        };

        // åŠ è½½æ¨¡æ‹Ÿæ•°æ®
        function loadMockData() {
            return new Promise((resolve) => {
                // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                setTimeout(() => {
                    showResult(mockData);
                    resolve(mockData);
                }, 500);
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        // åº”ç”¨åˆå§‹åŒ–
        function initializeApp() {
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // è·å–å½“å‰IPå¹¶æ˜¾ç¤º
            getCurrentIP();
            
            // æ£€æŸ¥URLä¸­æ˜¯å¦æœ‰IPå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const ipParam = urlParams.get('ip');
            
            if (ipParam) {
                document.getElementById('ip-input').value = ipParam;
                fetchIPInfo(ipParam);
            }
        }
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // å›è½¦é”®æŸ¥è¯¢
            document.getElementById('ip-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchIP();
                }
            });
            
            // å¤„ç†æµè§ˆå™¨å‰è¿›/åé€€
            window.addEventListener('popstate', handlePopState);
        }
        
        // å¤„ç†æµè§ˆå™¨å†å²è®°å½•å¯¼èˆª
        function handlePopState(event) {
            const urlParams = new URLSearchParams(window.location.search);
            const ip = urlParams.get('ip') || '';
            
            if (ip) {
                document.getElementById('ip-input').value = ip;
                fetchIPInfo(ip);
            } else {
                // å¦‚æœæ²¡æœ‰IPå‚æ•°ï¼Œæ¸…ç©ºè¾“å…¥æ¡†å¹¶æ˜¾ç¤ºå½“å‰IPä¿¡æ¯
                document.getElementById('ip-input').value = '';
                getCurrentIP();
            }
        }
        
        // è·å–å½“å‰ç”¨æˆ·IP
        async function getCurrentIP() {
            try {
                const response = await fetchWithTimeout(config.api.endpoints.currentIp);
                const data = await response.json();
                
                if (data && data.ip) {
                    document.getElementById('myIp').textContent = data.ip;
                    return data.ip;
                }
                throw new Error('Invalid response format');
            } catch (error) {
                console.error('è·å–IPå¤±è´¥:', error);
                document.getElementById('myIp').textContent = 'æœªçŸ¥';
                return null;
            }
        }
        
        // å¸¦è¶…æ—¶çš„fetchå°è£…
        function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const { timeout = config.api.timeout } = options;
            
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            return fetch(url, {
                ...options,
                signal: controller.signal
            }).finally(() => clearTimeout(timeoutId));
        }
        
        // éªŒè¯Turnstile token
        async function verifyTurnstile(token) {
            if (!token) throw new Error('Turnstile token is required');
            
            try {
                const response = await fetchWithTimeout(
                    new URL(config.api.endpoints.verifyTurnstile, config.api.baseUrl),
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ token })
                    }
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'TurnstileéªŒè¯å¤±è´¥');
                }
                
                const data = await response.json();
                return data.success === true;
                
            } catch (error) {
                console.error('TurnstileéªŒè¯é”™è¯¯:', error);
                return false;
            }
        }
        
        // å¸¦é‡è¯•çš„APIè¯·æ±‚
        async function fetchWithRetry(url, options = {}, retries = config.api.retryCount, delay = config.api.retryDelay) {
            try {
                const response = await fetchWithTimeout(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries <= 0) throw error;
                
                if (config.debug) {
                    console.log(`è¯·æ±‚å¤±è´¥ï¼Œ${delay}msåé‡è¯• (å‰©ä½™ ${retries} æ¬¡)...`);
                }
                
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchWithRetry(url, options, retries - 1, delay * 1.5);
            }
        }
        
        // æŸ¥è¯¢IPä¿¡æ¯
        async function fetchIPInfo(ip = '') {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            setLoadingState(true);
            
            // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            if (config.useMockData) {
                try {
                    await loadMockData();
                } catch (error) {
                    showError('æ¨¡æ‹Ÿæ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
                } finally {
                    setLoadingState(false);
                }
                return;
            }
            
            try {
                // éªŒè¯Turnstile token
                if (!turnstileToken) {
                    throw new Error('è¯·å®ŒæˆäººæœºéªŒè¯');
                }
                
                // éªŒè¯Turnstile token
                const isTurnstileValid = await verifyTurnstile(turnstileToken);
                if (!isTurnstileValid) {
                    throw new Error('äººæœºéªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                // æ„å»ºè¯·æ±‚URL
                const url = new URL(config.api.endpoints.ipInfo, config.api.baseUrl);
                if (ip) {
                    url.searchParams.append('ip', ip);
                    updateBrowserHistory(ip);
                }
                
                // å‘é€è¯·æ±‚
                const response = await fetchWithRetry(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-Turnstile-Token': turnstileToken
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
                showResult(data);
                
                // é‡ç½®Turnstile
                if (turnstile && turnstileWidgetId !== null) {
                    turnstile.reset(turnstileWidgetId);
                    turnstileToken = '';
                    document.getElementById('search-button').disabled = true;
                }
                
            } catch (error) {
                const errorMessage = error.name === 'AbortError' 
                    ? 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
                    : `æŸ¥è¯¢å¤±è´¥: ${error.message}`;
                
                showError(errorMessage);
                console.error('API Error:', error);
                
                // å‡ºé”™æ—¶é‡ç½®Turnstile
                if (turnstile && turnstileWidgetId !== null) {
                    turnstile.reset(turnstileWidgetId);
                    turnstileToken = '';
                    document.getElementById('search-button').disabled = true;
                }
            } finally {
                setLoadingState(false);
            }
        }
        
        // æ›´æ–°æµè§ˆå™¨å†å²è®°å½•
        function updateBrowserHistory(ip) {
            const url = new URL(window.location);
            url.searchParams.set('ip', ip);
            window.history.pushState({ ip }, '', url);
        }
        
        // è®¾ç½®åŠ è½½çŠ¶æ€
        function setLoadingState(isLoading) {
            const loadingElement = document.getElementById('loading');
            const resultElement = document.getElementById('result');
            
            if (isLoading) {
                loadingElement.style.display = 'block';
                resultElement.style.display = 'none';
                document.getElementById('error').style.display = 'none';
            } else {
                loadingElement.style.display = 'none';
            }
        }

        // å¤„ç†æœç´¢æŒ‰é’®ç‚¹å‡»
        function searchIP() {
            const ipInput = document.getElementById('ip-input');
            const ip = ipInput.value.trim();
            
            // å¦‚æœè¾“å…¥ä¸ºç©ºï¼ŒæŸ¥è¯¢å½“å‰IP
            if (!ip) {
                getCurrentIP().then(currentIp => {
                    if (currentIp) {
                        fetchIPInfo(currentIp);
                    } else {
                        showError('æ— æ³•è·å–å½“å‰IPåœ°å€');
                    }
                });
                return;
            }
            
            // éªŒè¯IPæ ¼å¼
            if (!isValidIP(ip)) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„IPv4æˆ–IPv6åœ°å€');
                return;
            }
            
            // æ‰§è¡ŒæŸ¥è¯¢
            fetchIPInfo(ip);
        }
        
        // éªŒè¯IPåœ°å€æ ¼å¼
        function isValidIP(ip) {
            // æ›´ä¸¥æ ¼çš„IPv4éªŒè¯
            const ipv4Pattern = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            
            // æ›´ä¸¥æ ¼çš„IPv6éªŒè¯
            const ipv6Pattern = /^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/;
            
            return ipv4Pattern.test(ip) || ipv6Pattern.test(ip);
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorElement = document.getElementById('error');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('result').style.display = 'none';
            
            // 3ç§’åè‡ªåŠ¨éšè—é”™è¯¯ä¿¡æ¯
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }
        
        // æ ¼å¼åŒ–JSONä¸ºHTML
        function formatJsonToHtml(data) {
            const escapeHtml = (str) => {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            };

            const formatValue = (value, level = 0) => {
                if (value === null) {
                    return '<span class="null">null</span>';
                }
                
                const type = typeof value;
                
                if (type === 'boolean') {
                    return `<span class="boolean">${value}</span>`;
                }
                
                if (type === 'number') {
                    return `<span class="number">${value}</span>`;
                }
                
                if (type === 'string') {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯URL
                    if (value.startsWith('http://') || value.startsWith('https://')) {
                        return `<span class="string">"<a href="${escapeHtml(value)}" target="_blank" rel="noopener noreferrer">${escapeHtml(value)}</a>"</span>`;
                    }
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é‚®ç®±
                    if (value.includes('@') && value.includes('.')) {
                        return `<span class="string">"<a href="mailto:${escapeHtml(value)}">${escapeHtml(value)}</a>"</span>`;
                    }
                    return `<span class="string">"${escapeHtml(value)}"</span>`;
                }
                
                if (Array.isArray(value)) {
                    if (value.length === 0) return '<span class="bracket">[]</span>';
                    
                    const id = 'arr_' + Math.random().toString(36).substr(2, 9);
                    let html = `<span class="collapsible" onclick="toggleCollapsible(this)" data-id="${id}">[</span>`;
                    html += `<div class="collapsible-content" id="${id}">`;
                    
                    value.forEach((item, index) => {
                        html += '<div style="margin-left: 20px;">';
                        html += formatValue(item, level + 1);
                        if (index < value.length - 1) html += ',';
                        html += '</div>';
                    });
                    
                    html += '</div><span class="bracket">]</span>';
                    return html;
                }
                
                if (type === 'object') {
                    const keys = Object.keys(value);
                    if (keys.length === 0) return '<span class="bracket">{}</span>';
                    
                    const id = 'obj_' + Math.random().toString(36).substr(2, 9);
                    let html = `<span class="collapsible" onclick="toggleCollapsible(this)" data-id="${id}">{</span>`;
                    html += `<div class="collapsible-content" id="${id}">`;
                    
                    keys.forEach((key, index) => {
                        html += '<div style="margin-left: 20px;">';
                        html += `<span class="key">"${key}"</span>: ${formatValue(value[key], level + 1)}`;
                        if (index < keys.length - 1) html += ',';
                        html += '</div>';
                    });
                    
                    html += '</div><span class="bracket">}</span>';
                    return html;
                }
                
                return `<span class="null">${escapeHtml(String(value))}</span>`;
            };
            
            return formatValue(data);
        }
        
        // åˆ‡æ¢å¯æŠ˜å å†…å®¹
        function toggleCollapsible(element) {
            element.classList.toggle('collapsed');
        }
        
        // åˆ‡æ¢JSONè§†å›¾
        function toggleJsonView() {
            const button = document.getElementById('toggleJsonView');
            const t = translations[currentLang];
            const isExpanded = button.textContent.includes(t.collapseAll);
            
            if (isExpanded) {
                button.querySelector('span').textContent = t.expandAll;
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.classList.remove('collapsed');
                });
            } else {
                button.querySelector('span').textContent = t.collapseAll;
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.classList.add('collapsed');
                });
            }
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        async function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent || element.innerText;
            
            try {
                await navigator.clipboard.writeText(text);
                const originalText = document.querySelector('.copy-button i').parentNode.innerHTML;
                const button = document.querySelector('.copy-button');
                button.innerHTML = '<i class="fas fa-check"></i> å·²å¤åˆ¶';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¹¶å¤åˆ¶');
            }
        }
        
        // æ ¼å¼åŒ–å®‰å…¨ä¿¡æ¯
        function formatSecurityInfo(security) {
            if (!security) return [];
            
            return [
                { label: 'VPN', value: security.is_vpn ? 'æ˜¯' : 'å¦', isThreat: security.is_vpn },
                { label: 'ä»£ç†', value: security.is_proxy ? 'æ˜¯' : 'å¦', isThreat: security.is_proxy },
                { label: 'Tor', value: security.is_tor ? 'æ˜¯' : 'å¦', isThreat: security.is_tor },
                { label: 'Torå‡ºå£èŠ‚ç‚¹', value: security.is_tor_exit ? 'æ˜¯' : 'å¦', isThreat: security.is_tor_exit },
                { label: 'äº‘æœåŠ¡å•†', value: security.is_cloud_provider ? 'æ˜¯' : 'å¦', isThreat: false },
                { label: 'åŒ¿å', value: security.is_anonymous ? 'æ˜¯' : 'å¦', isThreat: security.is_anonymous },
                { label: 'å¨èƒ', value: security.is_threat ? 'æ˜¯' : 'å¦', isThreat: security.is_threat },
                { label: 'æ»¥ç”¨IP', value: security.is_abuser ? 'æ˜¯' : 'å¦', isThreat: security.is_abuser },
                { label: 'æ”»å‡»è€…IP', value: security.is_attacker ? 'æ˜¯' : 'å¦', isThreat: security.is_attacker },
                { label: 'Bogonç½‘ç»œ', value: security.is_bogon ? 'æ˜¯' : 'å¦', isThreat: security.is_bogon },
                { label: 'ä¸­ç»§èŠ‚ç‚¹', value: security.is_relay ? 'æ˜¯' : 'å¦', isThreat: security.is_relay }
            ];
        }
        
        // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
        function showResult(data) {
            const t = translations[currentLang];
            
            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('resultIP').textContent = data.ip || t.unknown;
            document.getElementById('resultType').textContent = data.type || t.unknown;
            document.getElementById('resultHostname').textContent = data.hostname || t.unknown;
            
            // åœ°ç†ä½ç½®
            const countryText = data.location?.country ? 
                `${data.location.country.flag?.emoji || ''} ${data.location.country.name} (${data.location.country.code})` : t.unknown;
            document.getElementById('resultCountry').innerHTML = countryText;
            document.getElementById('resultRegion').textContent = data.location?.region?.name || t.unknown;
            document.getElementById('resultCity').textContent = data.location?.city || t.unknown;
            document.getElementById('resultPostal').textContent = data.location?.postal || t.unknown;
            
            const coordinates = data.location?.latitude ? 
                `${data.location.latitude}, ${data.location.longitude}` : t.unknown;
            document.getElementById('resultCoordinates').textContent = coordinates;
            
            const timezone = data.time_zone ? 
                `${data.time_zone.name} (${data.time_zone.abbreviation})` : t.unknown;
            document.getElementById('resultTimezone').textContent = timezone;
            
            // ç½‘ç»œä¿¡æ¯
            document.getElementById('resultISP').textContent = data.connection?.organization || t.unknown;
            document.getElementById('resultASN').textContent = data.connection?.asn ? 
                `AS${data.connection.asn}` : t.unknown;
            document.getElementById('resultRoute').textContent = data.connection?.route || t.unknown;
            
            // å…¬å¸ä¿¡æ¯
            const companyInfo = [];
            if (data.company) {
                if (data.company.name) companyInfo.push(`${t.companyName}: ${data.company.name}`);
                if (data.company.domain) companyInfo.push(`${t.companyDomain}: ${data.company.domain}`);
                if (data.company.type) companyInfo.push(`${t.type}: ${data.company.type}`);
            }
            
            // å®‰å…¨ä¿¡æ¯
            const securityInfo = [];
            if (data.security) {
                const securityItems = formatSecurityInfo(data.security);
                securityItems.forEach(item => {
                    const className = item.isThreat ? 'security-threat' : '';
                    securityInfo.push(`<span class="${className}">${item.label}: ${item.value}</span>`);
                });
            }
            
            // è´§å¸ä¿¡æ¯
            const currencyInfo = [];
            if (data.currency) {
                currencyInfo.push(`${data.currency.name} (${data.currency.code})`);
                currencyInfo.push(`${t.symbol}: ${data.currency.symbol}`);
                if (data.currency.format) {
                    currencyInfo.push(`${t.format}: ${data.currency.format.positive.prefix}1${data.currency.format.positive.suffix}`);
                }
            }
            
            // æ›´æ–°DOM
            updateSection('company-info', companyInfo.join(' â€¢ '));
            updateSection('security-info', securityInfo.join(' â€¢ '));
            updateSection('currency-info', currencyInfo.join(' â€¢ '));
            
            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            document.getElementById('result').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            
            // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºJSONæ•°æ®
            const jsonOutput = document.getElementById('json-output');
            jsonOutput.innerHTML = formatJsonToHtml(data);
            
            // åˆå§‹åŒ–ä¸ºæ”¶èµ·çŠ¶æ€
            setTimeout(() => {
                document.querySelectorAll('.collapsible').forEach(el => {
                    el.classList.add('collapsed');
                });
            }, 100);
        }
        
        // æ›´æ–°ä¿¡æ¯å—
        function updateSection(sectionId, content) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.innerHTML = content || translations[currentLang].unknown;
                element.style.display = content ? 'block' : 'none';
            }
        }
        
        // å¤„ç†æµè§ˆå™¨å‰è¿›/åé€€æŒ‰é’®
        window.onpopstate = function() {
            const path = window.location.pathname;
            if (path === '/' || path === '') {
                document.title = 'IP Info - My IP';
                document.getElementById('ip-input').value = '';
                // Only fetch visitor's IP if not already loaded
                if (!document.getElementById('ip-address').textContent) {
                    fetchIPInfo();
                }
            } else {
                const ip = path.substring(1);
                document.getElementById('ip-input').value = ip;
                document.title = `IP Info - ${ip}`;
                // Don't fetch IP info here, wait for user to submit the form
            }
        };

        // Turnstile çŠ¶æ€ç®¡ç†
        let turnstileToken = '';
        let turnstileWidgetId = null;
        
        // Turnstile åŠ è½½å®Œæˆå›è°ƒ
        window.onTurnstileLoad = function() {
            renderTurnstile();
            
            // å¦‚æœæ˜¯é¦–é¡µä¸”æ²¡æœ‰IPå‚æ•°ï¼Œè‡ªåŠ¨è·å–å½“å‰IPä¿¡æ¯
            const path = window.location.pathname;
            const urlParams = new URLSearchParams(window.location.search);
            
            if ((path === '/' || path === '') && !urlParams.has('ip')) {
                fetchIPInfo();
            }
        };
        
        // æ¸²æŸ“TurnstileéªŒè¯ç»„ä»¶
        function renderTurnstile() {
            // å¦‚æœTurnstileæœªåŠ è½½æˆ–å·²ç»æ¸²æŸ“è¿‡ï¼Œåˆ™è·³è¿‡
            if (typeof turnstile === 'undefined' || turnstileWidgetId !== null) {
                if (config.debug) {
                    console.log('Turnstile already rendered or not available');
                }
                return;
            }
            
            try {
                turnstileWidgetId = turnstile.render('#cf-turnstile', {
                    sitekey: config.turnstile.siteKey,
                    theme: config.turnstile.theme,
                    size: config.turnstile.size,
                    callback: function(token) {
                        if (config.debug) console.log('Turnstile callback with token:', token.substring(0, 10) + '...');
                        turnstileToken = token;
                        document.getElementById('search-button').disabled = false;
                    },
                    'expired-callback': function() {
                        if (config.debug) console.log('Turnstile token expired');
                        turnstileToken = '';
                        document.getElementById('search-button').disabled = true;
                    },
                    'error-callback': function() {
                        if (config.debug) console.error('Turnstile error');
                        turnstileToken = '';
                        document.getElementById('search-button').disabled = true;
                    }
                });
                
                if (config.debug) {
                    console.log('Turnstile rendered with widget ID:', turnstileWidgetId);
                }
                
            } catch (error) {
                console.error('Error rendering Turnstile:', error);
                // å¦‚æœTurnstileæ¸²æŸ“å¤±è´¥ï¼Œä»ç„¶å…è®¸æäº¤ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.warn('Running in development mode, bypassing Turnstile');
                    document.getElementById('search-button').disabled = false;
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            const searchButton = document.getElementById('search-button');
            const ipInput = document.getElementById('ip-input');
            
            // åˆå§‹ç¦ç”¨æœç´¢æŒ‰é’®ï¼ˆTurnstileéªŒè¯é€šè¿‡åå¯ç”¨ï¼‰
            searchButton.disabled = true;
            
            // å¼€å‘ç¯å¢ƒä¸‹è‡ªåŠ¨å¯ç”¨æœç´¢æŒ‰é’®
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                searchButton.disabled = false;
                if (config.debug) console.log('Development mode: search button enabled');
            }
            
            // Try to render Turnstile immediately (in case it's already loaded)
            renderTurnstile();
            
            // If Turnstile is not loaded yet, the onTurnstileLoad callback will handle it
            
            // Handle search form submission
            searchButton.addEventListener('click', searchIP);
            ipInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchIP();
                }
            });
            
            // Update URL and title based on current path
            const path = window.location.pathname;
            if (path !== '/' && path !== '') {
                const ip = path.substring(1);
                ipInput.value = ip;
                document.title = `IP Info - ${ip}`;
            }
        });
    </script>
</body>
</html>
